{"remainingRequest":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/thread-loader/dist/cjs.js!/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/babel-loader/lib/index.js!/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/src/views/components/trace/d3-trace.js","dependencies":[{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/src/views/components/trace/d3-trace.js","mtime":1592485041000},{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import _Set from \"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/@babel/runtime-corejs2/core-js/set\";\nimport _Array$from from \"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/@babel/runtime-corejs2/core-js/array/from\";\nimport _classCallCheck from \"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/@babel/runtime-corejs2/helpers/esm/createClass\";\n\n/**</template>\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements.  See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License.  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as d3 from 'd3';\nimport d3tip from 'd3-tip';\n/* eslint-disable */\n\nvar type = {\n  MQ: '#bf99f8',\n  Http: '#72a5fd',\n  Database: '#ff6732',\n  Unknown: '#ffc107',\n  Cache: '#00bcd4',\n  RPCFramework: '#ee4395'\n};\n\nvar Trace =\n/*#__PURE__*/\nfunction () {\n  function Trace(el, show) {\n    _classCallCheck(this, Trace);\n\n    this.barHeight = 48;\n    this.show = show;\n    this.el = el;\n    this.i = 0;\n    this.width = el.clientWidth;\n    this.height = el.clientHeight;\n    this.svg = d3.select(this.el).append('svg').attr('class', 'trace-list-dowanload').attr('width', this.width).attr('height', this.height);\n    this.treemap = d3.tree().size([this.height * 0.7, this.width]);\n    this.tip = d3tip().attr('class', 'd3-tip').offset([-8, 0]).html(function (d) {\n      return \"\\n      <div class=\\\"mb-5\\\">\".concat(d.data.label, \"</div>\\n      \").concat(d.data.dur ? '<div class=\"sm\">SelfDuration: ' + d.data.dur + 'ms</div>' : '', \"\\n      \").concat(d.data.endTime - d.data.startTime ? '<div class=\"sm\">TotalDuration: ' + (d.data.endTime - d.data.startTime) + 'ms</div>' : '', \"\\n      \");\n    });\n    this.svg.call(this.tip);\n  }\n\n  _createClass(Trace, [{\n    key: \"diagonal\",\n    value: function diagonal(d) {\n      return \"M \".concat(d.source.y, \" \").concat(d.source.x + 5, \"\\n    L \").concat(d.source.y, \" \").concat(d.target.x - 30, \"\\n    L\").concat(d.target.y, \" \").concat(d.target.x - 20, \"\\n    L\").concat(d.target.y, \" \").concat(d.target.x - 5);\n    }\n  }, {\n    key: \"init\",\n    value: function init(data, row) {\n      var _this = this;\n\n      d3.select('.trace-xaxis').remove();\n      this.row = row;\n      this.data = data;\n      this.min = d3.min(this.row.map(function (i) {\n        return i.startTime;\n      }));\n      this.max = d3.max(this.row.map(function (i) {\n        return i.endTime - _this.min;\n      }));\n      this.list = _Array$from(new _Set(this.row.map(function (i) {\n        return i.serviceCode;\n      })));\n      this.xScale = d3.scaleLinear().range([0, this.width * 0.387]).domain([0, this.max]);\n      this.xAxis = d3.axisTop(this.xScale).tickFormat(function (d) {\n        if (d === 0) return 0;\n        if (d >= 1000) return d / 1000 + 's';\n        return d;\n      });\n      this.svg.attr('height', (this.row.length + 1) * this.barHeight);\n      this.svg.append('g').attr('class', 'trace-xaxis').attr('transform', \"translate(\".concat(this.width * 0.618 - 20, \",\", 30, \")\")).call(this.xAxis);\n      this.sequentialScale = d3.scaleSequential().domain([0, this.list.length + 1]).interpolator(d3.interpolateCool);\n      this.root = d3.hierarchy(this.data, function (d) {\n        return d.children;\n      });\n      this.root.x0 = 0;\n      this.root.y0 = 0;\n    }\n  }, {\n    key: \"draw\",\n    value: function draw(callback) {\n      this.update(this.root, callback);\n    }\n  }, {\n    key: \"click\",\n    value: function click(d, scope) {\n      if (!d.data.type) return;\n\n      if (d.children) {\n        d._children = d.children;\n        d.children = null;\n      } else {\n        d.children = d._children;\n        d._children = null;\n      }\n\n      scope.update(d);\n    }\n  }, {\n    key: \"update\",\n    value: function update(source, callback) {\n      var _this2 = this;\n\n      var that = this;\n      var nodes = this.root.descendants();\n      var index = -1;\n      this.root.eachBefore(function (n) {\n        n.x = ++index * _this2.barHeight + 24;\n        n.y = n.depth * 12;\n      });\n      var node = this.svg.selectAll('.trace-node').data(nodes, function (d) {\n        return d.id || (d.id = ++_this2.i);\n      });\n      var nodeEnter = node.enter().append('g').attr('transform', \"translate(\".concat(source.y0, \",\").concat(source.x0, \")\")).attr('class', 'trace-node').style('opacity', 0).on('mouseover', function (d, i) {\n        that.tip.show(d, this);\n      }).on('mouseout', function (d, i) {\n        that.tip.hide(d, this);\n      }).on('click', function (d) {\n        that.show.handleSelectSpan(d);\n      });\n      nodeEnter.append('rect').attr('height', 42).attr('ry', 2).attr('rx', 2).attr('y', -22).attr('x', 20).attr('width', '100%').attr('fill', 'rgba(0,0,0,0)');\n      nodeEnter.append('text').attr('x', 13).attr('y', 5).attr('fill', '#E54C17').html(function (d) {\n        return d.data.isError ? '◉' : '';\n      });\n      nodeEnter.append('text').attr('class', 'node-text').attr('x', 35).attr('y', -6).attr('fill', '#333').text(function (d) {\n        if (d.data.label === 'TRACE_ROOT') {\n          return '';\n        }\n\n        return d.data.label.length > 40 ? \"\".concat(d.data.label.slice(0, 40), \"...\") : \"\".concat(d.data.label);\n      });\n      nodeEnter.append('text').attr('class', 'node-text').attr('x', 35).attr('y', 12).attr('fill', '#ccc').style('font-size', '11px').text(function (d) {\n        return \"\".concat(d.data.layer || '', \" \").concat(d.data.component ? '- ' + d.data.component : d.data.component || '');\n      });\n      nodeEnter.append('rect').attr('rx', 2).attr('ry', 2).attr('height', 4).attr('width', function (d) {\n        if (!d.data.endTime || !d.data.startTime) return 0;\n        return _this2.xScale(d.data.endTime - d.data.startTime) + 1 || 0;\n      }).attr('x', function (d) {\n        return !d.data.endTime || !d.data.startTime ? 0 : _this2.width * 0.618 - 20 - d.y + _this2.xScale(d.data.startTime - _this2.min) || 0;\n      }).attr('y', -2).style('fill', function (d) {\n        return \"\".concat(_this2.sequentialScale(_this2.list.indexOf(d.data.serviceCode)));\n      });\n      nodeEnter.transition().duration(400).attr('transform', function (d) {\n        return \"translate(\".concat(d.y, \",\").concat(d.x, \")\");\n      }).style('opacity', 1);\n      nodeEnter.append('circle').attr('r', 3).style('cursor', 'pointer').attr('stroke-width', 2.5).attr('fill', function (d) {\n        return d._children ? \"\".concat(_this2.sequentialScale(_this2.list.indexOf(d.data.serviceCode))) : 'rbga(0,0,0,0)';\n      }).style('stroke', function (d) {\n        return d.data.label === 'TRACE_ROOT' ? '' : \"\".concat(_this2.sequentialScale(_this2.list.indexOf(d.data.serviceCode)));\n      }).on('click', function (d) {\n        _this2.click(d, _this2);\n\n        d3.event.stopPropagation();\n      });\n      node.transition().duration(400).attr('transform', function (d) {\n        return \"translate(\".concat(d.y, \",\").concat(d.x, \")\");\n      }).style('opacity', 1).select('circle').attr('fill', function (d) {\n        return d._children ? \"\".concat(_this2.sequentialScale(_this2.list.indexOf(d.data.serviceCode))) : '';\n      }); // Transition exiting nodes to the parent's new position.\n\n      node.exit().transition().duration(400).attr('transform', \"translate(\".concat(source.y, \",\").concat(source.x, \")\")).style('opacity', 0).remove();\n      var link = this.svg.selectAll('.trace-link').data(this.root.links(), function (d) {\n        return d.target.id;\n      });\n      link.enter().insert('path', 'g').attr('class', 'trace-link').attr('fill', 'rgba(0,0,0,0)').attr('stroke', 'rgba(0, 0, 0, 0.1)').attr('stroke-width', 2).attr('d', function (d) {\n        var o = {\n          x: source.x0 + 35,\n          y: source.y0\n        };\n        return _this2.diagonal({\n          source: o,\n          target: o\n        });\n      }).transition().duration(400).attr('d', this.diagonal);\n      link.transition().duration(400).attr('d', this.diagonal);\n      link.exit().transition().duration(400).attr('d', function (d) {\n        var o = {\n          x: source.x + 35,\n          y: source.y\n        };\n        return _this2.diagonal({\n          source: o,\n          target: o\n        });\n      }).remove();\n      this.root.each(function (d) {\n        d.x0 = d.x;\n        d.y0 = d.y;\n      });\n\n      if (callback) {\n        callback();\n      }\n    }\n  }]);\n\n  return Trace;\n}();\n\nexport { Trace as default };",{"version":3,"sources":["/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/src/views/components/trace/d3-trace.js"],"names":["d3","d3tip","type","MQ","Http","Database","Unknown","Cache","RPCFramework","Trace","el","show","barHeight","i","width","clientWidth","height","clientHeight","svg","select","append","attr","treemap","tree","size","tip","offset","html","d","data","label","dur","endTime","startTime","call","source","y","x","target","row","remove","min","map","max","list","serviceCode","xScale","scaleLinear","range","domain","xAxis","axisTop","tickFormat","length","sequentialScale","scaleSequential","interpolator","interpolateCool","root","hierarchy","children","x0","y0","callback","update","scope","_children","that","nodes","descendants","index","eachBefore","n","depth","node","selectAll","id","nodeEnter","enter","style","on","hide","handleSelectSpan","isError","text","slice","layer","component","indexOf","transition","duration","click","event","stopPropagation","exit","link","links","insert","o","diagonal","each"],"mappings":"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","sourcesContent":["/**</template>\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements.  See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License.  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as d3 from 'd3';\nimport d3tip from 'd3-tip';\n/* eslint-disable */\nconst type = {\n  MQ: '#bf99f8',\n  Http: '#72a5fd',\n  Database: '#ff6732',\n  Unknown: '#ffc107',\n  Cache: '#00bcd4',\n  RPCFramework: '#ee4395',\n};\nexport default class Trace {\n  constructor(el, show) {\n    this.barHeight = 48;\n    this.show = show;\n    this.el = el;\n    this.i = 0;\n    this.width = el.clientWidth;\n    this.height = el.clientHeight;\n    this.svg = d3\n      .select(this.el)\n      .append('svg')\n      .attr('class', 'trace-list-dowanload')\n      .attr('width', this.width)\n      .attr('height', this.height);\n    this.treemap = d3.tree().size([this.height * 0.7, this.width]);\n    this.tip = d3tip()\n      .attr('class', 'd3-tip')\n      .offset([-8, 0])\n      .html(\n        (d) => `\n      <div class=\"mb-5\">${d.data.label}</div>\n      ${\n        d.data.dur\n          ? '<div class=\"sm\">SelfDuration: ' + d.data.dur + 'ms</div>'\n          : ''\n      }\n      ${\n        d.data.endTime - d.data.startTime\n          ? '<div class=\"sm\">TotalDuration: ' +\n            (d.data.endTime - d.data.startTime) +\n            'ms</div>'\n          : ''\n      }\n      `,\n      );\n    this.svg.call(this.tip);\n  }\n  diagonal(d) {\n    return `M ${d.source.y} ${d.source.x + 5}\n    L ${d.source.y} ${d.target.x - 30}\n    L${d.target.y} ${d.target.x - 20}\n    L${d.target.y} ${d.target.x - 5}`;\n  }\n  init(data, row) {\n    d3.select('.trace-xaxis').remove();\n    this.row = row;\n    this.data = data;\n    this.min = d3.min(this.row.map((i) => i.startTime));\n    this.max = d3.max(this.row.map((i) => i.endTime - this.min));\n    this.list = Array.from(new Set(this.row.map((i) => i.serviceCode)));\n    this.xScale = d3\n      .scaleLinear()\n      .range([0, this.width * 0.387])\n      .domain([0, this.max]);\n    this.xAxis = d3.axisTop(this.xScale).tickFormat((d) => {\n      if (d === 0) return 0;\n      if (d >= 1000) return d / 1000 + 's';\n      return d;\n    });\n    this.svg.attr('height', (this.row.length + 1) * this.barHeight);\n    this.svg\n      .append('g')\n      .attr('class', 'trace-xaxis')\n\n      .attr('transform', `translate(${this.width * 0.618 - 20},${30})`)\n      .call(this.xAxis);\n    this.sequentialScale = d3\n      .scaleSequential()\n      .domain([0, this.list.length + 1])\n      .interpolator(d3.interpolateCool);\n    this.root = d3.hierarchy(this.data, (d) => d.children);\n    this.root.x0 = 0;\n    this.root.y0 = 0;\n  }\n  draw(callback) {\n    this.update(this.root, callback);\n  }\n  click(d, scope) {\n    if (!d.data.type) return;\n    if (d.children) {\n      d._children = d.children;\n      d.children = null;\n    } else {\n      d.children = d._children;\n      d._children = null;\n    }\n    scope.update(d);\n  }\n  update(source, callback) {\n    const that = this;\n    const nodes = this.root.descendants();\n    let index = -1;\n    this.root.eachBefore((n) => {\n      n.x = ++index * this.barHeight + 24;\n      n.y = n.depth * 12;\n    });\n    const node = this.svg\n      .selectAll('.trace-node')\n      .data(nodes, (d) => d.id || (d.id = ++this.i));\n    const nodeEnter = node\n      .enter()\n      .append('g')\n      .attr('transform', `translate(${source.y0},${source.x0})`)\n      .attr('class', 'trace-node')\n      .style('opacity', 0)\n      .on('mouseover', function(d, i) {\n        that.tip.show(d, this);\n      })\n      .on('mouseout', function(d, i) {\n        that.tip.hide(d, this);\n      })\n      .on('click', function(d) {\n        that.show.handleSelectSpan(d);\n      });\n    nodeEnter\n      .append('rect')\n      .attr('height', 42)\n      .attr('ry', 2)\n      .attr('rx', 2)\n      .attr('y', -22)\n      .attr('x', 20)\n      .attr('width', '100%')\n      .attr('fill', 'rgba(0,0,0,0)');\n    nodeEnter\n      .append('text')\n      .attr('x', 13)\n      .attr('y', 5)\n      .attr('fill', '#E54C17')\n      .html((d) => (d.data.isError ? '◉' : ''));\n    nodeEnter\n      .append('text')\n      .attr('class', 'node-text')\n      .attr('x', 35)\n      .attr('y', -6)\n      .attr('fill', '#333')\n      .text((d) => {\n        if (d.data.label === 'TRACE_ROOT') {\n          return '';\n        }\n        return d.data.label.length > 40\n          ? `${d.data.label.slice(0, 40)}...`\n          : `${d.data.label}`;\n      });\n    nodeEnter\n      .append('text')\n      .attr('class', 'node-text')\n      .attr('x', 35)\n      .attr('y', 12)\n      .attr('fill', '#ccc')\n      .style('font-size', '11px')\n      .text(\n        (d) =>\n          `${d.data.layer || ''} ${\n            d.data.component ? '- ' + d.data.component : d.data.component || ''\n          }`,\n      );\n    nodeEnter\n      .append('rect')\n      .attr('rx', 2)\n      .attr('ry', 2)\n      .attr('height', 4)\n      .attr('width', (d) => {\n        if (!d.data.endTime || !d.data.startTime) return 0;\n        return this.xScale(d.data.endTime - d.data.startTime) + 1 || 0;\n      })\n      .attr('x', (d) =>\n        !d.data.endTime || !d.data.startTime\n          ? 0\n          : this.width * 0.618 -\n              20 -\n              d.y +\n              this.xScale(d.data.startTime - this.min) || 0,\n      )\n      .attr('y', -2)\n      .style(\n        'fill',\n        (d) => `${this.sequentialScale(this.list.indexOf(d.data.serviceCode))}`,\n      );\n    nodeEnter\n      .transition()\n      .duration(400)\n      .attr('transform', (d) => `translate(${d.y},${d.x})`)\n      .style('opacity', 1);\n    nodeEnter\n      .append('circle')\n      .attr('r', 3)\n      .style('cursor', 'pointer')\n      .attr('stroke-width', 2.5)\n      .attr('fill', (d) =>\n        d._children\n          ? `${this.sequentialScale(this.list.indexOf(d.data.serviceCode))}`\n          : 'rbga(0,0,0,0)',\n      )\n      .style('stroke', (d) =>\n        d.data.label === 'TRACE_ROOT'\n          ? ''\n          : `${this.sequentialScale(this.list.indexOf(d.data.serviceCode))}`,\n      )\n      .on('click', (d) => {\n        this.click(d, this);\n        d3.event.stopPropagation();\n      });\n    node\n      .transition()\n      .duration(400)\n      .attr('transform', (d) => `translate(${d.y},${d.x})`)\n      .style('opacity', 1)\n      .select('circle')\n      .attr('fill', (d) =>\n        d._children\n          ? `${this.sequentialScale(this.list.indexOf(d.data.serviceCode))}`\n          : '',\n      );\n\n    // Transition exiting nodes to the parent's new position.\n    node\n      .exit()\n      .transition()\n      .duration(400)\n      .attr('transform', `translate(${source.y},${source.x})`)\n      .style('opacity', 0)\n      .remove();\n    const link = this.svg\n      .selectAll('.trace-link')\n      .data(this.root.links(), function(d) {\n        return d.target.id;\n      });\n\n    link\n      .enter()\n      .insert('path', 'g')\n      .attr('class', 'trace-link')\n      .attr('fill', 'rgba(0,0,0,0)')\n      .attr('stroke', 'rgba(0, 0, 0, 0.1)')\n      .attr('stroke-width', 2)\n      .attr('d', (d) => {\n        const o = { x: source.x0 + 35, y: source.y0 };\n        return this.diagonal({ source: o, target: o });\n      })\n      .transition()\n      .duration(400)\n      .attr('d', this.diagonal);\n\n    link\n      .transition()\n      .duration(400)\n      .attr('d', this.diagonal);\n\n    link\n      .exit()\n      .transition()\n      .duration(400)\n      .attr('d', (d) => {\n        const o = { x: source.x + 35, y: source.y };\n        return this.diagonal({ source: o, target: o });\n      })\n      .remove();\n    this.root.each(function(d) {\n      d.x0 = d.x;\n      d.y0 = d.y;\n    });\n    if (callback) {\n      callback();\n    }\n  }\n}\n"]}]}