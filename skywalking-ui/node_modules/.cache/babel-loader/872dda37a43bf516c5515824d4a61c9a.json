{"remainingRequest":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/thread-loader/dist/cjs.js!/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/babel-loader/lib/index.js!/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/vue-loader/lib/index.js??vue-loader-options!/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/src/views/components/topology/chart/topo.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/src/views/components/topology/chart/topo.vue","mtime":1592485041000},{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.string.anchor\";\nimport \"core-js/modules/es6.string.link\";\nimport _objectSpread from \"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/@babel/runtime-corejs2/helpers/esm/objectSpread\";\nimport _objectWithoutProperties from \"/Volumes/Files/Study/apm/apache-skywalking-apm-8.0.1/skywalking-ui/node_modules/@babel/runtime-corejs2/helpers/esm/objectWithoutProperties\";\nimport \"core-js/modules/es6.function.name\";\nimport * as d3 from 'd3';\nimport d3tip from 'd3-tip';\nimport zoom from './utils/zoom';\nimport { simulationInit, simulationSkip } from './utils/simulation';\nimport nodeElement from './utils/nodeElement';\nimport { linkElement, anchorElement } from './utils/linkElement';\nimport tool from './utils/tool';\nexport default {\n  props: {\n    current: {\n      type: Object,\n      default: function _default() {\n        return {};\n      }\n    },\n    nodes: {\n      type: Array,\n      default: function _default() {\n        return [];\n      }\n    },\n    links: {\n      type: Array,\n      default: function _default() {\n        return [];\n      }\n    }\n  },\n  data: function data() {\n    return {\n      height: 600,\n      simulation: ''\n    };\n  },\n  beforeDestroy: function beforeDestroy() {\n    window.removeEventListener('resize', this.resize);\n  },\n  mounted: function mounted() {\n    var _this = this;\n\n    window.addEventListener('resize', this.resize);\n    this.svg = d3.select(this.$el).append('svg').attr('class', 'topo-svg').attr('height', this.$el.clientHeight);\n    this.tip = d3tip().attr('class', 'd3-tip').offset([-8, 0]);\n    this.graph = this.svg.append('g').attr('class', 'topo-svg_graph');\n    this.graph.call(this.tip);\n    this.simulation = simulationInit(d3, this.nodes, this.links, this.ticked);\n    this.svg.call(zoom(d3, this.graph));\n    this.node = this.graph.append('g').selectAll('.topo-node');\n    this.link = this.graph.append('g').selectAll('.topo-line');\n    this.anchor = this.graph.append('g').selectAll('.topo-line-anchor');\n    this.tool = tool(this.graph, [{\n      icon: 'API',\n      click: this.handleGoEndpoint\n    }, {\n      icon: 'INSTANCE',\n      click: this.handleGoInstance\n    }, {\n      icon: 'TRACE',\n      click: this.handleGoTrace\n    }, {\n      icon: 'ALARM',\n      click: this.handleGoAlarm\n    }, {\n      icon: ''\n    }, {\n      icon: ''\n    }]);\n    this.svg.on('click', function (d, i) {\n      event.stopPropagation();\n      event.preventDefault();\n\n      _this.$store.commit('rocketTopo/SET_NODE', {});\n\n      _this.$store.commit('rocketTopo/SET_LINK', {});\n\n      _this.$store.dispatch('rocketTopo/CLEAR_TOPO_INFO');\n\n      _this.tool.attr('style', 'display: none');\n    });\n  },\n  watch: {\n    nodes: 'update',\n    links: 'update'\n  },\n  methods: {\n    // alarm hexagon\n    handleGoAlarm: function handleGoAlarm() {\n      this.$emit('setDialog', 'alarm');\n    },\n    // trace hexagon\n    handleGoTrace: function handleGoTrace() {\n      this.$emit('setDialog', 'trace');\n    },\n    // instace hexagon\n    handleGoInstance: function handleGoInstance() {\n      this.$emit('setDialog', 'instance');\n    },\n    // endpoint hexagon\n    handleGoEndpoint: function handleGoEndpoint() {\n      this.$store.dispatch('SELECT_SERVICE', {\n        service: {\n          key: this.current.id,\n          label: this.current.name\n        },\n        duration: this.$store.getters.durationTime\n      });\n      this.$emit('setDialog', 'endpoint');\n    },\n    handleNodeClick: function handleNodeClick(d) {\n      this.$emit('setCurrent', {\n        key: d.id,\n        label: d.name\n      });\n\n      var x = d.x,\n          y = d.y,\n          vx = d.vx,\n          vy = d.vy,\n          fx = d.fx,\n          fy = d.fy,\n          index = d.index,\n          rest = _objectWithoutProperties(d, [\"x\", \"y\", \"vx\", \"vy\", \"fx\", \"fy\", \"index\"]);\n\n      this.$store.dispatch('rocketTopo/CLEAR_TOPO_INFO');\n      this.$store.commit('rocketTopo/SET_NODE', rest);\n      this.$store.commit('rocketTopo/SET_LINK', {});\n    },\n    handleLinkClick: function handleLinkClick(d) {\n      var _this2 = this;\n\n      event.stopPropagation();\n      this.$store.commit('rocketTopo/SET_NODE', {});\n      this.$store.commit('rocketTopo/SET_LINK', d);\n      this.$store.dispatch('rocketTopo/CLEAR_TOPO_INFO');\n      this.$store.commit('rocketTopo/SET_MODE', d.detectPoints);\n      this.$store.dispatch(this.$store.state.rocketTopo.mode ? 'rocketTopo/GET_TOPO_SERVICE_INFO' : 'rocketTopo/GET_TOPO_CLIENT_INFO', _objectSpread({}, d, {\n        duration: this.$store.getters.durationTime\n      }));\n      this.$store.commit('rocketTopo/SET_CALLBACK', function () {\n        _this2.$store.dispatch(_this2.$store.state.rocketTopo.mode ? 'rocketTopo/GET_TOPO_SERVICE_INFO' : 'rocketTopo/GET_TOPO_CLIENT_INFO', _objectSpread({}, d, {\n          duration: _this2.$store.getters.durationTime\n        }));\n      });\n    },\n    resize: function resize() {\n      this.svg.attr('height', this.$el.clientHeight);\n    },\n    update: function update() {\n      var _this3 = this;\n\n      // node element\n      var that = this;\n      this.node = this.node.data(this.nodes, function (d) {\n        return d.id;\n      });\n      this.node.exit().remove();\n      this.node = nodeElement(d3, this.node.enter(), this.tool, {\n        dragstart: this.dragstart,\n        dragged: this.dragged,\n        dragended: this.dragended,\n        handleNodeClick: this.handleNodeClick\n      }, this.tip).merge(this.node); // line element\n\n      this.link = this.link.data(this.links, function (d) {\n        return d.id;\n      });\n      this.link.exit().remove();\n      this.link = linkElement(this.link.enter()).merge(this.link); // anchorElement\n\n      this.anchor = this.anchor.data(this.links, function (d) {\n        return d.id;\n      });\n      this.anchor.exit().remove();\n      this.anchor = anchorElement(this.anchor.enter(), {\n        handleLinkClick: this.handleLinkClick,\n        $tip: function $tip(data) {\n          return \"\\n          <div class=\\\"mb-5\\\"><span class=\\\"grey\\\">\".concat(_this3.$t('cpm'), \": </span>\").concat(data.cpm, \"</div>\\n          <div class=\\\"mb-5\\\"><span class=\\\"grey\\\">\").concat(_this3.$t('latency'), \": </span>\").concat(data.latency, \"</div>\\n          <div><span class=\\\"grey\\\">\").concat(_this3.$t('detectPoint'), \":</span>\").concat(data.detectPoints.join(' | '), \"</div>\\n        \");\n        }\n      }, this.tip).merge(this.anchor); // force element\n\n      this.simulation.nodes(this.nodes);\n      this.simulation.force('link').links(this.links).id(function (d) {\n        return d.id;\n      });\n      simulationSkip(d3, this.simulation, this.ticked);\n    },\n    ticked: function ticked() {\n      this.link.attr('d', function (d) {\n        return \"M\".concat(d.source.x, \" \").concat(d.source.y, \" Q \").concat((d.source.x + d.target.x) / 2, \" \").concat((d.target.y + d.source.y) / 2 - 90, \" \").concat(d.target.x, \" \").concat(d.target.y);\n      });\n      this.anchor.attr('transform', function (d) {\n        return \"translate(\".concat((d.source.x + d.target.x) / 2, \", \").concat((d.target.y + d.source.y) / 2 - 45, \")\");\n      });\n      this.node.attr('transform', function (d) {\n        return \"translate(\".concat(d.x - 22, \",\").concat(d.y - 22, \")\");\n      });\n    },\n    dragstart: function dragstart(d) {\n      this.node._groups[0].forEach(function (g) {\n        g.__data__.fx = g.__data__.x;\n        g.__data__.fy = g.__data__.y;\n      });\n\n      if (!d3.event.active) {\n        this.simulation.alphaTarget(0.1).restart();\n      }\n\n      d3.event.sourceEvent.stopPropagation();\n    },\n    dragged: function dragged(d) {\n      d.fx = d3.event.x;\n      d.fy = d3.event.y;\n      d.x = d.fx;\n      d.y = d.fy;\n    },\n    dragended: function dragended() {\n      if (!d3.event.active) {\n        this.simulation.alphaTarget(0);\n      }\n    }\n  }\n};",{"version":3,"sources":["topo.vue"],"names":[],"mappings":"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","sourcesContent":["<!-- Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the \"License\"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n  http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License. -->\n<template>\n  <div class=\"micro-topo-chart\"></div>\n</template>\n<script lang=\"js\">\n  import * as d3 from 'd3';\n  import d3tip from 'd3-tip';\n  import zoom from './utils/zoom';\n  import { simulationInit, simulationSkip } from './utils/simulation';\n  import nodeElement from './utils/nodeElement';\n  import { linkElement, anchorElement } from './utils/linkElement';\n  import tool from './utils/tool';\n  export default {\n    props: {\n      current: {\n        type: Object,\n        default: () => ({}),\n      },\n      nodes: {\n        type: Array,\n        default: () => [],\n      },\n      links: {\n        type: Array,\n        default: () => [],\n      },\n    },\n    data() {\n      return {\n        height: 600,\n        simulation: '',\n      };\n    },\n    beforeDestroy() {\n      window.removeEventListener('resize', this.resize);\n    },\n    mounted() {\n      window.addEventListener('resize', this.resize);\n      this.svg = d3\n        .select(this.$el)\n        .append('svg')\n        .attr('class', 'topo-svg')\n        .attr('height', this.$el.clientHeight);\n      this.tip = d3tip()\n        .attr('class', 'd3-tip')\n        .offset([-8, 0]);\n      this.graph = this.svg.append('g').attr('class', 'topo-svg_graph');\n      this.graph.call(this.tip);\n      this.simulation = simulationInit(d3, this.nodes, this.links, this.ticked);\n      this.svg.call(zoom(d3, this.graph));\n      this.node = this.graph.append('g').selectAll('.topo-node');\n      this.link = this.graph.append('g').selectAll('.topo-line');\n      this.anchor = this.graph.append('g').selectAll('.topo-line-anchor');\n      this.tool = tool(this.graph, [\n        {icon: 'API', click: this.handleGoEndpoint},\n        {icon: 'INSTANCE', click: this.handleGoInstance},\n        {icon: 'TRACE', click: this.handleGoTrace},\n        {icon: 'ALARM', click: this.handleGoAlarm},\n        {icon: ''},\n        {icon: ''},\n      ]);\n      this.svg.on('click', (d, i) => {\n        event.stopPropagation();\n        event.preventDefault();\n        this.$store.commit('rocketTopo/SET_NODE', {});\n        this.$store.commit('rocketTopo/SET_LINK', {});\n        this.$store.dispatch('rocketTopo/CLEAR_TOPO_INFO');\n        this.tool.attr('style', 'display: none');\n      });\n    },\n    watch: {\n      nodes: 'update',\n      links: 'update',\n    },\n    methods: {\n      // alarm hexagon\n      handleGoAlarm() {\n        this.$emit('setDialog', 'alarm');\n      },\n      // trace hexagon\n      handleGoTrace() {\n        this.$emit('setDialog', 'trace');\n      },\n      // instace hexagon\n      handleGoInstance() {\n        this.$emit('setDialog', 'instance');\n      },\n      // endpoint hexagon\n      handleGoEndpoint() {\n        this.$store.dispatch('SELECT_SERVICE', {\n          service: { key: this.current.id, label: this.current.name },\n          duration: this.$store.getters.durationTime,\n        });\n        this.$emit('setDialog', 'endpoint');\n      },\n      handleNodeClick(d) {\n        this.$emit('setCurrent', { key: d.id, label: d.name });\n        const {x, y, vx, vy, fx, fy, index, ...rest} = d;\n        this.$store.dispatch('rocketTopo/CLEAR_TOPO_INFO');\n        this.$store.commit('rocketTopo/SET_NODE', rest);\n        this.$store.commit('rocketTopo/SET_LINK', {});\n      },\n      handleLinkClick(d) {\n        event.stopPropagation();\n        this.$store.commit('rocketTopo/SET_NODE', {});\n        this.$store.commit('rocketTopo/SET_LINK', d);\n        this.$store.dispatch('rocketTopo/CLEAR_TOPO_INFO');\n        this.$store.commit('rocketTopo/SET_MODE', d.detectPoints);\n        this.$store.dispatch(this.$store.state.rocketTopo.mode ? 'rocketTopo/GET_TOPO_SERVICE_INFO' :\n            'rocketTopo/GET_TOPO_CLIENT_INFO', { ...d, duration: this.$store.getters.durationTime });\n        this.$store.commit('rocketTopo/SET_CALLBACK', () => {\n          this.$store.dispatch(this.$store.state.rocketTopo.mode ? 'rocketTopo/GET_TOPO_SERVICE_INFO' :\n            'rocketTopo/GET_TOPO_CLIENT_INFO', { ...d, duration: this.$store.getters.durationTime });\n        });\n      },\n      resize() {\n        this.svg.attr('height', this.$el.clientHeight);\n      },\n      update() {\n        // node element\n        const that = this;\n        this.node = this.node.data(this.nodes, (d) => d.id);\n        this.node.exit().remove();\n        this.node = nodeElement(d3, this.node.enter(), this.tool, {\n          dragstart: this.dragstart,\n          dragged: this.dragged,\n          dragended: this.dragended,\n          handleNodeClick: this.handleNodeClick,\n        }, this.tip).merge(this.node);\n        // line element\n        this.link = this.link.data(this.links, (d) => d.id);\n        this.link.exit().remove();\n        this.link = linkElement(this.link.enter()).merge(this.link);\n        // anchorElement\n        this.anchor = this.anchor.data(this.links, (d) => d.id);\n        this.anchor.exit().remove();\n        this.anchor = anchorElement(this.anchor.enter(), {\n          handleLinkClick: this.handleLinkClick,\n          $tip: (data) =>\n          `\n            <div class=\"mb-5\"><span class=\"grey\">${this.$t('cpm')}: </span>${data.cpm}</div>\n            <div class=\"mb-5\"><span class=\"grey\">${this.$t('latency')}: </span>${data.latency}</div>\n            <div><span class=\"grey\">${this.$t('detectPoint')}:</span>${data.detectPoints.join(' | ')}</div>\n          `,\n        }, this.tip).merge(this.anchor);\n        // force element\n        this.simulation.nodes(this.nodes);\n        this.simulation.force('link').links(this.links).id((d) => d.id);\n        simulationSkip(d3, this.simulation, this.ticked);\n      },\n      ticked() {\n        this.link.attr('d', (d) => `M${d.source.x} ${d.source.y} Q ${(d.source.x + d.target.x) / 2} ${(d.target.y + d.source.y) / 2 - 90} ${d.target.x} ${d.target.y}`);\n        this.anchor.attr('transform', (d) => `translate(${(d.source.x + d.target.x) / 2}, ${(d.target.y + d.source.y) / 2 - 45})`);\n        this.node.attr('transform', (d) => `translate(${d.x - 22},${d.y - 22})`);\n      },\n      dragstart(d) {\n        this.node._groups[0].forEach((g) => {\n          g.__data__.fx = g.__data__.x;\n          g.__data__.fy = g.__data__.y;\n        });\n        if (!d3.event.active) {\n          this.simulation.alphaTarget(0.1).restart();\n        }\n        d3.event.sourceEvent.stopPropagation();\n      },\n      dragged(d) {\n        d.fx = d3.event.x;\n        d.fy = d3.event.y;\n        d.x = d.fx;\n        d.y = d.fy;\n      },\n      dragended() {\n        if (!d3.event.active) {\n          this.simulation.alphaTarget(0);\n        }\n      },\n    },\n  };\n</script>\n<style lang=\"scss\">\n  .micro-topo-chart {\n    height: 100%;\n    width: 100%;\n    .topo-svg {\n      display: block;\n      width: 100%;\n    }\n    .topo-line {\n      stroke-linecap: round;\n      stroke-width: 1.3px !important;\n      stroke-dasharray: 13 7;\n      fill: none;\n      animation: topo-dash 1s linear infinite !important;\n    }\n    .topo-line-anchor {\n      cursor: pointer;\n    }\n    .topo-text {\n      font-family: 'Lato', 'Source Han Sans CN', 'Microsoft YaHei', sans-serif;\n      fill: #ddd;\n      font-size: 11px;\n      opacity: 0.8;\n    }\n    .topo-tool {\n      display: none;\n    }\n    .topo-tool-i {\n      cursor: pointer;\n      .tool-hexagon {\n        fill: #3f4450;\n        stroke: #217ef2;\n        stroke-width: 2;\n        stroke-opacity: 0.5;\n      }\n      &:hover {\n        .tool-hexagon {\n          stroke-opacity: 1;\n        }\n      }\n    }\n  }\n  @keyframes topo-dash {\n    from {\n      stroke-dashoffset: 20;\n    }\n    to {\n      stroke-dashoffset: 0;\n    }\n  }\n</style>\n"],"sourceRoot":"src/views/components/topology/chart"}]}